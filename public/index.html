<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZyG - Discord VC Attendance Live</title>
<style>
/* ------------------ GENERAL ------------------ */
body { 
  font-family: 'Segoe UI', sans-serif; 
  background:#0d1117; 
  color:#e6edf3; 
  margin:0; 
  padding:0; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
}
h1 { 
  color:#238636; 
  margin:20px 0; 
  text-align:center;
  word-break: break-word;
  flex:1;
}

/* ------------------ HEADER ------------------ */
header {
  width: 100%;
  display:flex;
  justify-content:center;
  align-items:center;
  padding: 10px 20px;
  box-sizing: border-box;
  position: relative;
}
.admin-controls {
  display:flex;
  align-items:center;
  gap:10px;
  position: absolute;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  flex-wrap: nowrap;
}
.admin-controls input, .admin-controls button {
  padding:6px 10px;
  border-radius:6px;
  border:none;
  font-size:0.9em;
}
.admin-controls input { border:1px solid #30363d; background:#0d1117; color:#e6edf3; }

/* ------------------ CONTAINER ------------------ */
.container { 
  display:flex; 
  gap:20px; 
  width:95%; 
  box-sizing:border-box;
  align-items: flex-start;
}

/* LEFT COLUMN */
#mainPanel { 
  flex: 2;
  min-width: 400px;
}

/* RIGHT COLUMN */
.rightColumn {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-width: 300px;
}

/* ------------------ PANEL ------------------ */
.panel { 
  background:#161b22; 
  border:1px solid #30363d; 
  border-radius:12px; 
  padding:20px; 
  box-sizing:border-box;
}
table { width:100%; border-collapse:collapse; }
th,td { border-bottom:1px solid #30363d; padding:6px 10px; text-align:left; }
th { color:#238636; }
.joined { color:#2ea043; }
.left { color:#da3633; }
#history { max-height:150px; overflow-y:auto; font-size:0.9em; }
#vcAlert { margin-bottom:10px; font-weight:bold; display:none; font-size:1em; }
textarea { width:100%; height:60px; background:#0d1117; color:#e6edf3; border:1px solid #30363d; border-radius:6px; margin-top:10px; padding:6px; resize:none; }

/* BUTTON STYLING */
button { 
  background:#238636; 
  color:#fff; 
  border:none; 
  border-radius:6px; 
  padding:6px 12px; 
  margin-top:6px; 
  cursor:pointer; 
  transition:0.2s;
}
button:hover { background:#2ea043; }

/* Tab buttons plain + merged */
#tabMarket, #tabScreenshot {
  background:#0d1117;
  border:1px solid #30363d;
  border-radius:6px 0 0 6px;
  padding:6px 12px;
  margin-top:10px;
  cursor:pointer;
  flex:1;
  text-align:center;
}
#tabScreenshot { border-radius:0 6px 6px 0; margin-left:-1px; }
.tab-active { background:#30363d; color:#fff; }

/* File input styling hidden unless admin */
#marketScreensInput, #uploadMarketScreensBtn, #clearMarketScreensBtn { display:none; }

.status-icons { font-size:16px; }
input[type="file"] { margin-top:10px; }

/* ------------------ RESPONSIVE ------------------ */
@media(max-width:900px){
  .container{flex-direction:column; align-items:center;}
  header{justify-content:center; padding:10px;}
  .admin-controls{position: absolute; top:10px; right:10px; transform:none; flex-wrap:wrap;}
  #mainPanel, .rightColumn{min-width:95%;}
}
</style>
</head>
<body>

<header>
  <h1>ZyG - Discord VC Attendance Live</h1>
  <div class="admin-controls">
    <span id="adminStatus" style="display:none; font-weight:bold; color:#2ea043;">Admin Logged In</span>
    <button id="adminBtn">Admin Login</button>
    <input type="password" id="adminPassword" placeholder="Password" style="display:none;">
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</header>

<div class="container">

  <!-- LEFT: Main Panel -->
  <div class="panel" id="mainPanel">
    <h2>üì¢ Announcements</h2>
    <div id="announcementDisplay"></div>
    <textarea id="announcementInput" placeholder="Enter announcement..."></textarea>
    <button id="addAnnouncementBtn">Add</button>
    <button id="editAnnouncementBtn">Edit</button>
    <button id="updateAnnouncementBtn">Update</button>
    <button id="deleteAnnouncementBtn">Delete</button>

    <div style="display:flex; gap:0; margin-top:20px;">
      <button id="tabMarket" class="tab-active">Next Market</button>
      <button id="tabScreenshot">Screenshot</button>
    </div>

    <!-- MARKET TABLE -->
    <div id="marketTab" style="margin-top:10px;">
      <input type="file" id="marketExcelInput" accept=".xlsx,.xls">
      <button id="importMarketBtn">Import Excel</button>
      <button id="clearMarketBtn">Clear Table</button>
      <table id="marketTable">
        <thead><tr><th>Date</th><th>Item</th><th>Price</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SCREENSHOT GALLERY -->
    <div id="screenshotTab" style="display:none; margin-top:10px;">
      <input type="file" id="marketScreensInput" multiple accept="image/*">
      <button id="uploadMarketScreensBtn">Upload Screenshot</button>
      <button id="clearMarketScreensBtn">Clear Screenshots</button>
      <div id="screenshotGallery" style="display:flex; gap:5px; flex-wrap:wrap; margin-top:10px;"></div>
    </div>
  </div>

  <!-- RIGHT COLUMN: VC + Image stacked -->
  <div class="rightColumn">

    <!-- ACTIVE VC PANEL -->
    <div class="panel" id="vcPanel">
      <h2>üü¢ Live Voice Chat - Lordnine</h2>
      <div id="vcAlert"></div>
      <table id="active">
        <thead><tr><th>User</th><th>Channel</th><th>Status</th><th>Duration</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- IMAGE UPLOAD PANEL UNDER VC (ADMIN ONLY) -->
    <div class="panel" id="imagePanel" style="display:none;">
      <h2>üñºÔ∏è Upload image/screenshot for Attendance</h2>
      <input type="file" id="imageInput" multiple accept="image/*">
      <button id="uploadImagesBtn">Upload to Table</button>
      <table id="imageTable">
        <thead><tr><th>Preview</th><th>Filename</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
      <textarea id="imageMessage" placeholder="Optional message to send with the images..."></textarea>
      <button id="sendImagesBtn">Send All to Discord</button>
      <button id="clearImageTableBtn">Clear Table</button>
      <button id="toggleHistoryBtn">Show Join/Leave History</button>
      <div id="notification" style="display:none;">‚úÖ Images successfully uploaded! Clearing table...</div>
      <div id="history" style="display:none;"></div>

      <!-- ADMIN SETTINGS PANEL -->
      <div id="adminSettings" style="margin-top:15px;">
        <h3>‚öôÔ∏è Admin Settings</h3>
        <input type="text" id="webhookURL" placeholder="Webhook URL">
        <input type="text" id="voiceChannelID" placeholder="Voice Channel ID">
        <input type="text" id="serverID" placeholder="Server ID">
        <div style="margin-top:5px;">
          <button id="saveSettingsBtn">Save</button>
          <button id="defaultSettingsBtn">Default</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// -------------------- SOCKET.IO & VC --------------------
const socket = io();
let attendance = {};
const activeBody = document.querySelector("#active tbody");
const historyDiv = document.getElementById("history");
const vcAlert = document.getElementById("vcAlert");

function showVCAlert(message, type) {
  vcAlert.textContent = message;
  vcAlert.style.color = type==="join"?"#2ea043":"#da3633";
  vcAlert.style.display="block";
  setTimeout(()=>{vcAlert.style.display="none";},5000);
}

function formatDuration(sec){
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

function updateActive(){
  activeBody.innerHTML="";
  const now=new Date();
  Object.entries(attendance.active||{}).forEach(([user,info])=>{
    const joined=new Date(info.joinedAt||Date.now());
    const durationText=formatDuration(Math.floor((now-joined)/1000));
    const muteIcon=info.selfMute||info.serverMute?"üîá":"üé§";
    const deafIcon=info.selfDeaf||info.serverDeaf?"üîï":"üëÇ";
    const statusText=`<span class="status-icons">${muteIcon} ${deafIcon}</span>`;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${user}</td><td>${info.channel||"Unknown"}</td><td>${statusText}</td><td>${durationText}</td>`;
    activeBody.appendChild(tr);
  });
}

function updateHistory(){
  historyDiv.innerHTML="";
  (attendance.history||[]).slice(0,20).forEach(h=>{
    const div=document.createElement("div");
    const time=new Date(h.time).toLocaleTimeString();
    div.innerHTML=`<span class="${h.type==="join"?"joined":"left"}">${h.user}</span> ${h.type==="join"?"joined":"left"} <b>${h.channel}</b> at ${time}`;
    historyDiv.appendChild(div);
  });
}

setInterval(updateActive,1000);

socket.on("connect",()=>console.log("‚úÖ Connected to server"));
socket.on("update",data=>{
  const last=attendance.history?.[0];
  attendance=data;
  updateActive();
  updateHistory();
  if(last && last.time!==attendance.history?.[0]?.time){
    showVCAlert(`${attendance.history[0].user} ${attendance.history[0].type==="join"?"joined":"left"} ${attendance.history[0].channel}`,attendance.history[0].type);
  }
});

// -------------------- ADMIN LOGIN --------------------
const adminBtn=document.getElementById("adminBtn");
const adminPassword=document.getElementById("adminPassword");
const logoutBtn=document.getElementById("logoutBtn");
const imagePanel=document.getElementById("imagePanel");
const adminStatus=document.getElementById("adminStatus");
const mainPanel=document.getElementById("mainPanel");

const screenshotInput=document.getElementById("marketScreensInput");
const uploadBtn=document.getElementById("uploadMarketScreensBtn");
const clearBtn=document.getElementById("clearMarketScreensBtn");

let adminLoggedIn = localStorage.getItem("adminLoggedIn")==="true";

function updateAdminUI(){
  adminStatus.style.display = adminLoggedIn?"inline-block":"none";
  logoutBtn.style.display = adminLoggedIn?"inline-block":"none";
  adminBtn.style.display = adminLoggedIn?"none":"inline-block";
  imagePanel.style.display = adminLoggedIn?"block":"none";

  screenshotInput.style.display = adminLoggedIn?"inline-block":"none";
  uploadBtn.style.display = adminLoggedIn?"inline-block":"none";
  clearBtn.style.display = adminLoggedIn?"inline-block":"none";

  mainPanel.querySelectorAll("textarea, #addAnnouncementBtn, #editAnnouncementBtn, #updateAnnouncementBtn, #deleteAnnouncementBtn, #marketExcelInput, #importMarketBtn, #clearMarketBtn").forEach(el=>{
    el.style.display = adminLoggedIn?"inline-block":"none";
  });

  adminPassword.style.display = adminLoggedIn?"none":"inline-block";
  adminPassword.value="";
}

adminBtn.addEventListener("click",()=>{ 
  adminPassword.style.display="inline-block"; 
  adminPassword.focus(); 
});

adminPassword.addEventListener("keyup",e=>{
  if(e.key==="Enter"){
    if(adminPassword.value==="0212"){
      adminLoggedIn=true;
      localStorage.setItem("adminLoggedIn","true");
      updateAdminUI();
      alert("‚úÖ Admin logged in!");
    } else { 
      alert("‚ùå Incorrect password"); 
      adminPassword.value=""; 
    }
  }
});

logoutBtn.addEventListener("click",()=>{
  adminLoggedIn=false;
  localStorage.setItem("adminLoggedIn","false");
  updateAdminUI();
  alert("‚úÖ Logged out successfully!");
});

updateAdminUI();

// -------------------- TAB SWITCH --------------------
const tabMarket=document.getElementById("tabMarket");
const tabScreenshot=document.getElementById("tabScreenshot");
const marketTab=document.getElementById("marketTab");
const screenshotTab=document.getElementById("screenshotTab");

tabMarket.addEventListener("click",()=>{
  marketTab.style.display="block";
  screenshotTab.style.display="none";
  tabMarket.classList.add("tab-active");
  tabScreenshot.classList.remove("tab-active");
});
tabScreenshot.addEventListener("click",()=>{
  marketTab.style.display="none";
  screenshotTab.style.display="block";
  tabMarket.classList.remove("tab-active");
  tabScreenshot.classList.add("tab-active");
});

// -------------------- SCREENSHOT DISPLAY --------------------
let screenshots=JSON.parse(localStorage.getItem("screenshots")||"[]");
const screenshotGallery=document.getElementById("screenshotGallery");

function renderScreenshots(){
  screenshotGallery.innerHTML="";
  screenshots.forEach(img=>{
    const imgEl=document.createElement("img");
    imgEl.src=img;
    imgEl.style.width="80px";
    imgEl.style.height="80px";
    imgEl.style.objectFit="cover";
    imgEl.style.cursor="pointer";
    imgEl.title="Click to view full image";
    imgEl.addEventListener("click",()=>window.open(img,"_blank"));
    screenshotGallery.appendChild(imgEl);
  });
}
renderScreenshots();

uploadBtn.addEventListener("click",()=>{
  Array.from(screenshotInput.files).forEach(file=>{
    const reader=new FileReader();
    reader.onload=e=>{
      screenshots.push(e.target.result);
      localStorage.setItem("screenshots",JSON.stringify(screenshots));
      renderScreenshots();
    };
    reader.readAsDataURL(file);
  });
  screenshotInput.value="";
});

clearBtn.addEventListener("click",()=>{
  screenshots=[];
  localStorage.removeItem("screenshots");
  renderScreenshots();
});

// -------------------- ADMIN SETTINGS --------------------
const webhookURLInput = document.getElementById("webhookURL");
const voiceChannelInput = document.getElementById("voiceChannelID");
const serverIDInput = document.getElementById("serverID");
const saveSettingsBtn = document.getElementById("saveSettingsBtn");
const defaultSettingsBtn = document.getElementById("defaultSettingsBtn");

function loadSettings(){
  webhookURLInput.value = localStorage.getItem("webhookURL") || "";
  voiceChannelInput.value = localStorage.getItem("voiceChannelID") || "";
  serverIDInput.value = localStorage.getItem("serverID") || "";
}
function saveSettings(){
  localStorage.setItem("webhookURL", webhookURLInput.value);
  localStorage.setItem("voiceChannelID", voiceChannelInput.value);
  localStorage.setItem("serverID", serverIDInput.value);
  alert("‚úÖ Settings saved!");
}
function defaultSettings(){
  localStorage.removeItem("webhookURL");
  localStorage.removeItem("voiceChannelID");
  localStorage.removeItem("serverID");
  loadSettings();
  alert("‚úÖ Settings reset to default!");
}
saveSettingsBtn.addEventListener("click", saveSettings);
defaultSettingsBtn.addEventListener("click", defaultSettings);
loadSettings();

// -------------------- IMAGE PANEL FUNCTIONALITY (FIXED) --------------------
const imageInput = document.getElementById("imageInput");
const uploadImagesBtn = document.getElementById("uploadImagesBtn");
const clearImageTableBtn = document.getElementById("clearImageTableBtn");
const sendImagesBtn = document.getElementById("sendImagesBtn");
const toggleHistoryBtn = document.getElementById("toggleHistoryBtn");
const imageTableBody = document.getElementById("imageTable").querySelector("tbody");
const imageMessage = document.getElementById("imageMessage");
const notification = document.getElementById("notification");

let imageFiles = [];

// Render image table
function renderImageTable() {
  imageTableBody.innerHTML = "";
  imageFiles.forEach(file => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><img src="${file.data}" style="width:60px;height:60px;object-fit:cover;"></td>
      <td>${file.name}</td>
      <td>${file.status || "Pending"}</td>
    `;
    imageTableBody.appendChild(tr);
  });
}

// Upload images
uploadImagesBtn.addEventListener("click", () => {
  Array.from(imageInput.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      imageFiles.push({ name: file.name, data: e.target.result, status: "Pending" });
      renderImageTable();
    };
    reader.readAsDataURL(file);
  });
  imageInput.value = "";
});

// Clear image table
clearImageTableBtn.addEventListener("click", () => {
  imageFiles = [];
  renderImageTable();
  notification.style.display = "none";
});

// Toggle join/leave history
toggleHistoryBtn.addEventListener("click", () => {
  if (historyDiv.style.display === "none") {
    historyDiv.style.display = "block";
    toggleHistoryBtn.textContent = "Hide Join/Leave History";
  } else {
    historyDiv.style.display = "none";
    toggleHistoryBtn.textContent = "Show Join/Leave History";
  }
});

// Send images to Discord webhook
sendImagesBtn.addEventListener("click", async () => {
  if (!webhookURLInput.value) return alert("‚ùå Please set the webhook URL in Admin Settings.");
  if (imageFiles.length === 0) return alert("‚ùå No images to send.");

  sendImagesBtn.disabled = true;
  for (const file of imageFiles) {
    try {
      const formData = new FormData();
      formData.append("file", dataURLtoBlob(file.data), file.name);
      if (imageMessage.value) formData.append("content", imageMessage.value);

      await fetch(webhookURLInput.value, { method: "POST", body: formData });
      file.status = "Sent ‚úÖ";
      renderImageTable();
    } catch (err) {
      file.status = "Failed ‚ùå";
      renderImageTable();
      console.error("Error sending image:", err);
    }
  }
  notification.style.display = "block";
  setTimeout(() => {
    imageFiles = [];
    renderImageTable();
    notification.style.display = "none";
  }, 3000);
  sendImagesBtn.disabled = false;
});

// Helper: Convert dataURL to Blob
function dataURLtoBlob(dataurl) {
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--){
    u8arr[n] = bstr.charCodeAt(n);
  }
  return new Blob([u8arr], {type:mime});
}

// -------------------- MARKET TABLE FUNCTIONALITY --------------------
const marketExcelInput = document.getElementById("marketExcelInput");
const importMarketBtn = document.getElementById("importMarketBtn");
const clearMarketBtn = document.getElementById("clearMarketBtn");
const marketTableBody = document.getElementById("marketTable").querySelector("tbody");

importMarketBtn.addEventListener("click", async () => {
  if (!marketExcelInput.files.length) return alert("‚ùå Please select an Excel file.");
  const file = marketExcelInput.files[0];
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data);
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(sheet);
  marketTableBody.innerHTML = "";
  rows.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.Date || ""}</td><td>${row.Item || ""}</td><td>${row.Price || ""}</td>`;
    marketTableBody.appendChild(tr);
  });
});

clearMarketBtn.addEventListener("click", () => {
  marketTableBody.innerHTML = "";
  marketExcelInput.value = "";
});
</script>

<!-- XLSX library -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>

