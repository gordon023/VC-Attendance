<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discord VC Attendance Tracker</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
/* ====== RESET & BASE ====== */
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f7fa; color:#1c1f26; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
h1 { color:#2c3e50; margin:20px 0; font-weight:700; text-align:center; }
.container { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; width:95%; max-width:1200px; }

/* ====== PANELS ====== */
.panel { background:#ffffff; border-radius:12px; padding:20px; flex:1 1 350px; max-width:500px; box-shadow:0 4px 15px rgba(0,0,0,0.1); transition:transform 0.2s; }
.panel:hover { transform:translateY(-2px); }
.panel h2 { margin-bottom:15px; font-size:1.25rem; color:#34495e; display:flex; align-items:center; gap:8px; }

/* ====== TABLES ====== */
table { width:100%; border-collapse:collapse; margin-bottom:10px; }
th,td { text-align:left; padding:10px 8px; border-bottom:1px solid #e1e4e8; font-size:0.95rem; }
th { color:#2c3e50; font-weight:600; }
.joined { color:#27ae60; font-weight:500; }
.left { color:#c0392b; font-weight:500; }
#history { max-height:200px; overflow-y:auto; margin-top:10px; display:none; font-size:0.9rem; line-height:1.3; }

/* ====== TOAST ====== */
.toast { color:#d35400; font-weight:600; margin-bottom:10px; display:none; background:#fdf2e9; padding:8px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }

/* ====== INPUTS & BUTTONS ====== */
input[type="file"], textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; font-size:0.95rem; background:#f7f9fc; color:#1c1f26; }
textarea { resize:none; min-height:60px; }
button { background:#3498db; color:#fff; border:none; border-radius:8px; padding:8px 14px; margin-top:6px; font-size:0.95rem; cursor:pointer; transition:0.2s; }
button:hover { background:#2980b9; }
#notification { display:none; color:#27ae60; margin-top:10px; font-weight:600; }

/* ====== IMAGE PREVIEW ====== */
#imageTable img { max-width:60px; max-height:60px; border-radius:6px; object-fit:cover; }
.status-icons { font-size:16px; }

/* ====== SCROLLBARS ====== */
#history::-webkit-scrollbar, #imageTable::-webkit-scrollbar { width:6px; }
#history::-webkit-scrollbar-thumb, #imageTable::-webkit-scrollbar-thumb { background:#ccc; border-radius:3px; }
#history::-webkit-scrollbar-track, #imageTable::-webkit-scrollbar-track { background:#f1f1f1; }

@media(max-width:768px) {
  .container { flex-direction:column; align-items:center; }
}
</style>
</head>
<body>

<h1>üéß Discord VC Attendance Tracker</h1>
<div class="container">

<div class="panel">
<h2>üü¢ Active Voice Chat Members</h2>
<div id="toast" class="toast"></div>
<table id="active">
<thead><tr><th>User</th><th>Channel</th><th>Status</th><th>Duration</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div class="panel">
<h2>üñºÔ∏è Image Uploader</h2>
<input type="file" id="imageInput" multiple accept="image/*">
<button onclick="uploadImages()">Upload to Table</button>
<table id="imageTable">
<thead><tr><th>Preview</th><th>Filename</th><th>Status</th></tr></thead>
<tbody></tbody>
</table>
<textarea id="imageMessage" placeholder="Optional message to send with the images..."></textarea>
<button onclick="sendImagesToDiscord()">Send All to Discord</button>
<button onclick="clearImageTable()">üßπ Clear Table</button>
<button onclick="toggleHistory()">üìú History</button>
<div id="history"></div>
<div id="notification">‚úÖ Images successfully uploaded! Clearing table...</div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// ====== SOCKET.IO & ATTENDANCE LOGIC ======
const socket = io();
let attendance = {};
const activeBody = document.querySelector("#active tbody");
const historyDiv = document.querySelector("#history");
const toastDiv = document.getElementById("toast");

socket.on("connect", () => console.log("‚úÖ Connected to server"));
socket.on("update", (data) => {
  const oldActive = JSON.parse(JSON.stringify(attendance.active || {}));
  attendance = data;
  updateActive();
  updateHistory();
  showToastChanges(oldActive, attendance.active);
});

// --------------- VC PANEL -----------------
function updateActive() {
  activeBody.innerHTML = "";
  const now = new Date();
  Object.entries(attendance.active || {}).forEach(([user, info]) => {
    const joined = new Date(info.joinedAt || Date.now());
    const durationSec = Math.floor((now - joined)/1000);
    const durationText = formatDuration(durationSec);
    const muteIcon = info.selfMute || info.serverMute ? "üîá" : "üé§";
    const deafIcon = info.selfDeaf || info.serverDeaf ? "üîï" : "üëÇ";
    const statusText = `<span class="status-icons">${muteIcon} ${deafIcon}</span>`;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${user}</td><td>${info.channel || "Unknown"}</td><td>${statusText}</td><td>${durationText}</td>`;
    activeBody.appendChild(tr);
  });
}

function updateHistory() {
  historyDiv.innerHTML = "";
  (attendance.history || []).slice(0,20).forEach(h => {
    const div = document.createElement("div");
    const time = new Date(h.time).toLocaleTimeString();
    const typeClass = h.type === "join" ? "joined" : "left";
    const action = h.type === "join" ? "joined" : "left";
    div.innerHTML = `<span class="${typeClass}">${h.user}</span> ${action} <b>${h.channel}</b> at ${time}`;
    historyDiv.appendChild(div);
  });
}

function showToastChanges(oldActive, newActive) {
  const now = Date.now();
  let message = "";
  Object.keys(newActive).forEach(user => { if(!oldActive[user]) message += `üü¢ ${user} joined VC\n`; });
  Object.keys(oldActive).forEach(user => { if(!newActive[user]) message += `üî¥ ${user} left VC\n`; });
  if(message) {
    toastDiv.innerText = message.trim();
    toastDiv.style.display = "block";
    setTimeout(()=>toastDiv.style.display="none",20000);
  }
}

function formatDuration(sec) {
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

setInterval(updateActive, 1000);

// --------------- IMAGE UPLOADER -----------------
const imageInput = document.getElementById("imageInput");
const imageTableBody = document.querySelector("#imageTable tbody");
const notification = document.getElementById("notification");
const messageInput = document.getElementById("imageMessage");
let uploadedImages = JSON.parse(localStorage.getItem("uploadedImages") || "[]");
renderImageTable();

function uploadImages() {
  const files = Array.from(imageInput.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      uploadedImages.push({ name:file.name, dataURL:e.target.result, status:"Pending" });
      saveAndRender();
    };
    reader.readAsDataURL(file);
  });
  imageInput.value = "";
}

function renderImageTable() {
  imageTableBody.innerHTML = "";
  uploadedImages.forEach(img => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><img src="${img.dataURL}"></td><td>${img.name}</td><td>${img.status}</td>`;
    imageTableBody.appendChild(tr);
  });
}

function saveAndRender() {
  localStorage.setItem("uploadedImages", JSON.stringify(uploadedImages));
  renderImageTable();
}

function clearImageTable() {
  uploadedImages = [];
  saveAndRender();
  notification.style.display = "none";
  messageInput.value = "";
}

// --------------- CAPTURE VC PANEL -----------------
async function captureVCPannel() {
  const panel = document.querySelector(".panel:first-child");
  const canvas = await html2canvas(panel);
  const dataURL = canvas.toDataURL("image/png");
  uploadedImages.push({ name:`VC_Attendance_${Date.now()}.png`, dataURL, status:"Pending" });
  saveAndRender();
}

// --------------- SEND IMAGES TO DISCORD -----------------
async function sendImagesToDiscord() {
  if(uploadedImages.length===0) return alert("No images to send!");
  const message = messageInput.value.trim() || "üñºÔ∏è New images uploaded!";
  await captureVCPannel();
  fetch("/upload-images", {
    method:"POST",
    body: JSON.stringify({ images: uploadedImages, message }),
    headers: { "Content-Type":"application/json" }
  }).then(res=>res.json()).then(res=>{
    if(res.success){
      uploadedImages.forEach(img=>img.status="Sent");
      saveAndRender();
      notification.style.display="block";
      setTimeout(()=>clearImageTable(),15000);
    } else alert("Failed to send images.");
  }).catch(err=>console.error(err));
}

// --------------- TOGGLE HISTORY -----------------
function toggleHistory() {
  historyDiv.style.display = historyDiv.style.display==="none" ? "block":"none";
}
</script>
</body>
</html>
