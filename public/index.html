<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VC Attendance & Admin Panel</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  .panel { border: 1px solid #ccc; padding: 10px; margin: 10px; }
  .hidden { display: none; }
  .tabs { display: flex; gap: 10px; cursor: pointer; }
  .tabs div { padding: 5px 10px; border: 1px solid #ccc; }
  .tabs div.active { background: #eee; font-weight: bold; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 5px; text-align: left; }
  img { max-width: 100%; }
  #vcAlert { display: none; padding: 5px; margin: 5px 0; }
</style>
</head>
<body>

<!-- ===================== ADMIN LOGIN ===================== -->
<div class="panel">
  <button id="adminBtn">Admin Login</button>
  <input type="password" id="adminPassword" class="adminOnly hidden" placeholder="Enter Password">
  <button id="logoutBtn" class="adminOnly hidden">Logout</button>
  <span id="adminStatus" class="adminOnly hidden">Logged in as Admin</span>
</div>

<!-- ===================== MAIN PANEL ===================== -->
<div class="panel" id="mainPanel">
  
  <!-- ANNOUNCEMENT -->
  <h2>üì¢ Announcement</h2>
  <div id="announcementDisplay"></div>
  <textarea id="announcementInput" class="adminOnly" placeholder="Add announcement here..."></textarea>
  <div class="adminOnly">
    <button id="addAnnouncementBtn">Add</button>
    <button id="editAnnouncementBtn">Edit</button>
    <button id="updateAnnouncementBtn">Update</button>
    <button id="deleteAnnouncementBtn">Delete</button>
  </div>

  <!-- NEXT MARKET | SCREENSHOT TABS -->
  <div class="tabs">
    <div id="tabMarket" class="active">Next Market</div>
    <div id="tabScreenshot">Screenshot</div>
  </div>

  <!-- NEXT MARKET TAB -->
  <div id="marketTab">
    <h3>Next Market Table</h3>
    <input type="file" id="marketExcelInput" class="adminOnly">
    <button id="importMarketBtn" class="adminOnly">Import Excel</button>
    <button id="clearMarketBtn" class="adminOnly">Clear Table</button>
    <table id="marketTable">
      <thead>
        <tr><th>Date</th><th>Item Name</th><th>Price</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- SCREENSHOT TAB -->
  <div id="screenshotTab" class="hidden">
    <h3>Screenshot Gallery</h3>
    <input type="file" id="marketScreensInput" class="adminOnly" multiple accept="image/*">
    <button id="uploadMarketScreensBtn" class="adminOnly">Upload</button>
    <button id="clearMarketScreensBtn" class="adminOnly">Clear</button>
    <div id="screenshotGallery"></div>
  </div>
  
</div>

<!-- ===================== ACTIVE VOICE PANEL ===================== -->
<div class="panel" id="vcPanel">
  <h2>Active Voice Channel</h2>
  <div id="vcAlert"></div>
  <table id="active">
    <thead>
      <tr><th>User</th><th>Channel</th><th>Status</th><th>Duration</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="history" style="display:none;"></div>
</div>

<!-- ===================== IMAGE UPLOAD PANEL ===================== -->
<div class="panel hidden adminOnly" id="imagePanel">
  <h2>üñºÔ∏è Upload image/screenshot for Attendance</h2>
  <input type="file" id="imageInput" multiple accept="image/*">
  <button onclick="uploadImages()">Upload to Table</button>
  <table id="imageTable">
    <thead><tr><th>Preview</th><th>Filename</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>
  <textarea id="imageMessage" placeholder="Optional message to send with the images..."></textarea>
  <button onclick="sendImagesToDiscord()">Send All to Discord</button>
  <button onclick="clearImageTable()">Clear Table</button>
  <button onclick="toggleHistoryPanel()">Show Join/Leave History</button>
  <div id="notification">‚úÖ Images successfully uploaded! Clearing table...</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
// -------------------- SOCKET.IO --------------------
const socket = io();
let attendance = {};
const activeBody = document.querySelector("#active tbody");
const historyDiv = document.querySelector("#history");
const vcAlert = document.getElementById("vcAlert");

// -------------------- VC ALERT --------------------
function showVCAlert(message, type) {
  vcAlert.textContent = message;
  vcAlert.style.color = type === "join" ? "#2ea043" : "#da3633";
  vcAlert.style.display = "block";
  setTimeout(() => { vcAlert.style.display = "none"; }, 5000);
}

// -------------------- ACTIVE VC --------------------
function updateActive() {
  activeBody.innerHTML = "";
  const now = new Date();
  Object.entries(attendance.active || {}).forEach(([user, info]) => {
    const joined = new Date(info.joinedAt || Date.now());
    const durationSec = Math.floor((now - joined)/1000);
    const durationText = formatDuration(durationSec);
    const muteIcon = info.selfMute || info.serverMute ? "üîá" : "üé§";
    const deafIcon = info.selfDeaf || info.serverDeaf ? "üîï" : "üëÇ";
    const statusText = `<span class="status-icons">${muteIcon} ${deafIcon}</span>`;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${user}</td><td>${info.channel || "Unknown"}</td><td>${statusText}</td><td>${durationText}</td>`;
    activeBody.appendChild(tr);
  });
}

function updateHistory() {
  historyDiv.innerHTML = "";
  (attendance.history || []).slice(0,20).forEach(h => {
    const div = document.createElement("div");
    const time = new Date(h.time).toLocaleTimeString();
    const typeClass = h.type === "join" ? "joined" : "left";
    const action = h.type === "join" ? "joined" : "left";
    div.innerHTML = `<span class="${typeClass}">${h.user}</span> ${action} <b>${h.channel}</b> at ${time}`;
    historyDiv.appendChild(div);
  });
}

function formatDuration(sec) {
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

setInterval(updateActive, 1000);

socket.on("connect", () => console.log("‚úÖ Connected to server"));
socket.on("update", (data) => {
  const oldHistory = attendance.history || [];
  attendance = data;
  updateActive();
  updateHistory();

  let lastDisplayedTime = localStorage.getItem("lastDisplayedTime") || 0;
  const last = attendance.history[0];
  if(last && last.time > lastDisplayedTime) {
    const now = Date.now();
    if(now - last.time <= 5000) {
      showVCAlert(`${last.user} ${last.type === "join" ? "joined" : "left"} ${last.channel}`, last.type);
    }
    lastDisplayedTime = last.time;
    localStorage.setItem("lastDisplayedTime", lastDisplayedTime);
  }
});

// -------------------- IMAGE UPLOADER --------------------
const imageInput = document.getElementById("imageInput");
const imageTableBody = document.querySelector("#imageTable tbody");
const notification = document.getElementById("notification");
const messageInput = document.getElementById("imageMessage");
let uploadedImages = JSON.parse(localStorage.getItem("uploadedImages") || "[]");
renderImageTable();

function uploadImages() {
  const files = Array.from(imageInput.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      uploadedImages.push({ name:file.name, dataURL:e.target.result, status:"Pending" });
      saveAndRender();
    };
    reader.readAsDataURL(file);
  });
  imageInput.value = "";
}

function renderImageTable() {
  imageTableBody.innerHTML = "";
  uploadedImages.forEach(img => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><img src="${img.dataURL}" style="max-width:50px;max-height:50px;"></td><td>${img.name}</td><td>${img.status}</td>`;
    imageTableBody.appendChild(tr);
  });
}

function saveAndRender() {
  localStorage.setItem("uploadedImages", JSON.stringify(uploadedImages));
  renderImageTable();
}

function clearImageTable() {
  uploadedImages = [];
  saveAndRender();
  notification.style.display = "none";
  messageInput.value = "";
}

async function captureVCPannel() {
  const panel = document.querySelector("#vcPanel");
  const canvas = await html2canvas(panel);
  const dataURL = canvas.toDataURL("image/png");
  uploadedImages.push({ name:`VC_Attendance_${Date.now()}.png`, dataURL, status:"Pending" });
  saveAndRender();
}

async function sendImagesToDiscord() {
  if(uploadedImages.length===0) return alert("No images to send!");
  const message = messageInput.value.trim() || "Attendance Today has been uploaded!";
  await captureVCPannel();
  fetch("https://vc-attendance.onrender.com/upload-images", {
    method:"POST",
    body: JSON.stringify({ images: uploadedImages, message }),
    headers: { "Content-Type":"application/json" }
  }).then(res=>res.json()).then(res=>{
    if(res.success){
      uploadedImages.forEach(img=>img.status="Sent");
      saveAndRender();
      notification.style.display="block";
      setTimeout(()=>clearImageTable(),15000);
    } else alert("Failed to send images.");
  }).catch(err=>console.error(err));
}

function toggleHistoryPanel() {
  historyDiv.style.display = historyDiv.style.display === "none" ? "block" : "none";
}

// -------------------- ADMIN LOGIN/LOGOUT --------------------
const adminBtn = document.getElementById("adminBtn");
const adminPassword = document.getElementById("adminPassword");
const logoutBtn = document.getElementById("logoutBtn");
const imagePanel = document.getElementById("imagePanel");
const adminStatus = document.getElementById("adminStatus");
const mainPanel = document.getElementById("mainPanel");

let adminLoggedIn = localStorage.getItem("adminLoggedIn") === "true";

function updateAdminUI() {
  adminLoggedIn = localStorage.getItem("adminLoggedIn") === "true";

  adminStatus.style.display = adminLoggedIn ? "inline-block" : "none";
  logoutBtn.style.display = adminLoggedIn ? "inline-block" : "none";
  adminBtn.style.display = adminLoggedIn ? "none" : "inline-block";

  // Image panel
  if(adminLoggedIn) imagePanel.classList.remove("hidden");
  else imagePanel.classList.add("hidden");

  // Show/hide all admin-only elements
  document.querySelectorAll(".adminOnly").forEach(el=>{
    el.style.display = adminLoggedIn ? "" : "none";
  });
}

adminBtn.addEventListener("click", () => {
  adminPassword.style.display = "inline-block";
  adminPassword.focus();
});

adminPassword.addEventListener("keyup", e => {
  if (e.key === "Enter") {
    if (adminPassword.value === "0212") {
      localStorage.setItem("adminLoggedIn", "true");
      updateAdminUI();
      alert("‚úÖ Admin logged in!");
    } else {
      alert("‚ùå Incorrect password");
      adminPassword.value = "";
    }
  }
});

logoutBtn.addEventListener("click", () => {
  localStorage.setItem("adminLoggedIn", "false");
  updateAdminUI();
  alert("‚úÖ Logged out successfully!");
});

// -------------------- ANNOUNCEMENT --------------------
let announcementText = localStorage.getItem("announcementText") || "";
const announcementDisplay = document.getElementById("announcementDisplay");
const announcementInput = document.getElementById("announcementInput");

function renderAnnouncement() {
  announcementDisplay.textContent = announcementText;
  announcementInput.value = announcementText;
}
renderAnnouncement();

document.getElementById("addAnnouncementBtn").addEventListener("click", ()=>{
  announcementText = announcementInput.value.trim();
  localStorage.setItem("announcementText", announcementText);
  renderAnnouncement();
});

document.getElementById("editAnnouncementBtn").addEventListener("click", ()=>{
  announcementInput.value = announcementText;
});

document.getElementById("updateAnnouncementBtn").addEventListener("click", ()=>{
  announcementText = announcementInput.value.trim();
  localStorage.setItem("announcementText", announcementText);
  renderAnnouncement();
});

document.getElementById("deleteAnnouncementBtn").addEventListener("click", ()=>{
  announcementText = "";
  localStorage.removeItem("announcementText");
  renderAnnouncement();
});

// -------------------- TAB SWITCH --------------------
const tabMarket = document.getElementById("tabMarket");
const tabScreenshot = document.getElementById("tabScreenshot");
const marketTab = document.getElementById("marketTab");
const screenshotTab = document.getElementById("screenshotTab");

tabMarket.addEventListener("click", ()=>{
  marketTab.style.display = "block";
  screenshotTab.style.display = "none";
  tabMarket.classList.add("active");
  tabScreenshot.classList.remove("active");
});

tabScreenshot.addEventListener("click", ()=>{
  marketTab.style.display = "none";
  screenshotTab.style.display = "block";
  tabScreenshot.classList.add("active");
  tabMarket.classList.remove("active");
});

// -------------------- SCREENSHOT DISPLAY --------------------
const screenshotInput = document.getElementById("marketScreensInput");
const screenshotGallery = document.getElementById("screenshotGallery");
let screenshots = JSON.parse(localStorage.getItem("screenshots") || "[]");

function renderScreenshots() {
  screenshotGallery.innerHTML = "";
  screenshots.forEach((img)=>{
    const imgEl = document.createElement("img");
    imgEl.src = img;
    imgEl.style.width = "80px";
    imgEl.style.height = "80px";
    imgEl.style.objectFit = "cover";
    imgEl.style.cursor = "pointer";
    imgEl.title = "Click to view full image";
    imgEl.addEventListener("click", ()=>window.open(img, "_blank"));
    screenshotGallery.appendChild(imgEl);
  });
}
renderScreenshots();

document.getElementById("uploadMarketScreensBtn").addEventListener("click", ()=>{
  const files = Array.from(screenshotInput.files);
  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = (e)=>{
      screenshots.push(e.target.result);
      localStorage.setItem("screenshots", JSON.stringify(screenshots));
      renderScreenshots();
    };
    reader.readAsDataURL(file);
  });
  screenshotInput.value = "";
});

document.getElementById("clearMarketScreensBtn").addEventListener("click", ()=>{
  screenshots = [];
  localStorage.removeItem("screenshots");
  renderScreenshots();
});

// -------------------- INITIALIZE --------------------
updateAdminUI();
</script>
</body>
</html>
