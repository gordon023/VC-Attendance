<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discord VC Attendance Tracker</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#0d1117; color:#e6edf3; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; }
    h1 { color:#238636; margin:20px; }
    .container { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; width:90%; }
    .panel { background:#161b22; border:1px solid #30363d; border-radius:12px; padding:20px; flex:1 1 300px; max-width:500px; }
    table { width:100%; border-collapse:collapse; }
    th,td { border-bottom:1px solid #30363d; padding:6px 10px; text-align:left; }
    th { color:#238636; }
    .joined { color:#238636; }
    .left { color:#da3633; }
    #history { max-height:250px; overflow-y:auto; }
    #notification { margin-top:10px; color:#2ea043; font-weight:bold; display:none; text-align:center; }
    .progress-bar { height:6px; background:#238636; border-radius:3px; margin-top:4px; transition:width 0.3s ease; }
  </style>
</head>
<body>
  <h1>üéß Discord VC Attendance Tracker</h1>
  <div class="container">
    <div class="panel">
      <h2>üü¢ Active Voice Chat Members</h2>
      <table id="active">
        <thead><tr><th>User</th><th>Channel</th><th>Duration</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h2>üìú Join/Leave History</h2>
      <div id="history"></div>
    </div>

    <div class="panel">
      <h2>üñºÔ∏è Image Uploader</h2>
      <input type="file" id="imageInput" multiple accept="image/*">
      <button onclick="uploadImages()">Upload to Table</button>
      <button onclick="clearImageTable()">üßπ Clear Table</button>
      <table id="imageTable">
        <thead><tr><th>Preview</th><th>Filename</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
      <button onclick="sendImagesToDiscord()">Send All to Discord</button>
      <div id="notification">‚úÖ Images successfully uploaded! Clearing table...</div>
    </div>
  </div>

  <script>
    // ---------- VC ATTENDANCE ----------
    const socket = io();
    let attendance = {};
    const activeBody = document.querySelector("#active tbody");
    const historyDiv = document.querySelector("#history");

    socket.on("connect", () => console.log("‚úÖ Connected to server"));
    socket.on("update", (data) => {
      attendance = data;
      updateActive();
      updateHistory();
    });

    function updateActive() {
      activeBody.innerHTML = "";
      const now = new Date();
      Object.entries(attendance.active || {}).forEach(([user, info]) => {
        const joined = new Date(info.joinedAt);
        const durationSec = Math.floor((now - joined)/1000);
        const durationText = formatDuration(durationSec);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${user}</td><td>${info.channel}</td><td>${durationText}</td>`;
        activeBody.appendChild(tr);
      });
    }

    function updateHistory() {
      historyDiv.innerHTML = "";
      (attendance.history || []).slice(0, 20).forEach(h => {
        const div = document.createElement("div");
        const time = new Date(h.time).toLocaleTimeString();
        const typeClass = h.type === "join" ? "joined" : "left";
        const action = h.type === "join" ? "joined" : "left";
        div.innerHTML = `<span class="${typeClass}">${h.user}</span> ${action} <b>${h.channel}</b> at ${time}`;
        historyDiv.appendChild(div);
      });
    }

    function formatDuration(sec) {
      const h = Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }
    setInterval(updateActive, 1000);

    // ---------- IMAGE UPLOADER ----------
    const imageInput = document.getElementById("imageInput");
    const imageTableBody = document.querySelector("#imageTable tbody");
    const notification = document.getElementById("notification");
    let uploadedImages = JSON.parse(localStorage.getItem("uploadedImages") || "[]");

    renderImageTable();

    function uploadImages() {
      const files = Array.from(imageInput.files);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          uploadedImages.push({ name: file.name, dataURL: e.target.result, status: "Pending", progress: 0 });
          saveAndRender();
        };
        reader.readAsDataURL(file);
      });
      imageInput.value = "";
    }

    function renderImageTable() {
      imageTableBody.innerHTML = "";
      uploadedImages.forEach((img, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img src="${img.dataURL}" style="max-width:50px;max-height:50px;"></td>
          <td>${img.name}<div class="progress-bar" style="width:${img.progress || 0}%;"></div></td>
          <td>${img.status}</td>
        `;
        imageTableBody.appendChild(tr);
      });
    }

    function saveAndRender() {
      localStorage.setItem("uploadedImages", JSON.stringify(uploadedImages));
      renderImageTable();
    }

    function clearImageTable() {
      if (confirm("Are you sure you want to clear all images?")) {
        uploadedImages = [];
        saveAndRender();
      }
    }

    function sendImagesToDiscord() {
      if (uploadedImages.length === 0) return alert("No images to send!");
      uploadedImages.forEach(img => (img.status = "Uploading..."));
      saveAndRender();

      const total = uploadedImages.length;
      let uploaded = 0;

      fetch("/upload-images", {
        method: "POST",
        body: JSON.stringify(uploadedImages),
        headers: { "Content-Type": "application/json" }
      })
        .then(res => res.json())
        .then(res => {
          if (res.success) {
            uploadedImages.forEach(img => img.status = "Sent");
            saveAndRender();
            notification.style.display = "block";
            setTimeout(() => {
              uploadedImages = [];
              saveAndRender();
              notification.style.display = "none";
            }, 15000);
          } else {
            alert("Failed to send images: " + (res.error || "Unknown error"));
          }
        })
        .catch(err => console.error("Upload failed:", err));
    }
  </script>
</body>
</html>
