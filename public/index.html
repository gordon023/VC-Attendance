<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZyG - Discord VC Attendance Live</title>
<style>
/* --- Base Styles --- */
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0d1117;
  color: #e6edf3;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1 { color: #238636; margin: 20px 0; text-align: center; word-break: break-word; }
header { width: 100%; display: flex; justify-content: center; align-items: center; padding: 10px 20px; position: relative; }
.admin-controls { display: flex; align-items: center; gap: 10px; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
.admin-controls input, .admin-controls button { padding: 6px 10px; border-radius: 6px; border: none; font-size: 0.9em; }
.admin-controls input { border: 1px solid #30363d; background: #0d1117; color: #e6edf3; }

.container { display: flex; gap: 20px; width: 95%; box-sizing: border-box; align-items: flex-start; }
#mainPanel { flex: 2; min-width: 400px; }
.rightColumn { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 300px; }

.panel { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; box-sizing: border-box; }
table { width: 100%; border-collapse: collapse; }
th, td { border-bottom: 1px solid #30363d; padding: 6px 10px; text-align: left; }
th { color: #238636; }
.joined { color: #2ea043; }
.left { color: #da3633; }
#history { max-height: 150px; overflow-y: auto; font-size: 0.9em; }
#vcAlert { margin-bottom: 10px; font-weight: bold; display: none; font-size: 1em; }

textarea { width: 100%; height: 60px; background: #0d1117; color: #e6edf3; border: 1px solid #30363d; border-radius: 6px; margin-top: 10px; padding: 6px; resize: none; }
button { background: #238636; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; margin-top: 6px; cursor: pointer; transition: 0.2s; }
button:hover { background: #2ea043; }

#tabMarket, #tabScreenshot { background: #0d1117; border: 1px solid #30363d; border-radius: 6px 0 0 6px; padding: 6px 12px; margin-top: 10px; cursor: pointer; flex: 1; text-align: center; }
#tabScreenshot { border-radius: 0 6px 6px 0; margin-left: -1px; }
.tab-active { background: #30363d; color: #fff; }

#marketScreensInput, #uploadMarketScreensBtn, #clearMarketScreensBtn { display: none; }

@media(max-width:900px){
  .container { flex-direction: column; align-items: center; }
  header { justify-content: center; padding: 10px; }
  .admin-controls { position: absolute; top: 10px; right: 10px; transform: none; }
  #mainPanel, .rightColumn { min-width: 95%; }
}
</style>
</head>
<body>

<header>
  <h1>ZyG - Discord VC Attendance Live</h1>
  <div class="admin-controls">
    <span id="adminStatus" style="display:none; font-weight:bold; color:#2ea043;">Admin Logged In</span>
    <button id="adminBtn">Admin Login</button>
    <input type="password" id="adminPassword" placeholder="Password" style="display:none;">
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</header>

<div class="container">
  <!-- MAIN PANEL -->
  <div class="panel" id="mainPanel">
    <h2>üì¢ Announcements</h2>
    <div id="announcementDisplay"></div>
    <textarea id="announcementInput" placeholder="Enter announcement..."></textarea>
    <button id="addAnnouncementBtn">Add</button>
    <button id="editAnnouncementBtn">Edit</button>
    <button id="updateAnnouncementBtn">Update</button>
    <button id="deleteAnnouncementBtn">Delete</button>

    <div id="mainTabs" style="display:none;">
      <div style="display:flex; gap:0; margin-top:20px;">
        <button id="tabMarket" class="tab-active">Next Market</button>
        <button id="tabScreenshot">Screenshot</button>
      </div>

      <div id="marketTab" style="margin-top:10px;">
        <input type="file" id="marketExcelInput" accept=".xlsx,.xls">
        <button id="importMarketBtn">Import Excel</button>
        <button id="clearMarketBtn">Clear Table</button>
        <table id="marketTable">
          <thead><tr><th>Date</th><th>Item</th><th>Price</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="screenshotTab" style="display:none; margin-top:10px;">
        <input type="file" id="marketScreensInput" multiple accept="image/*">
        <button id="uploadMarketScreensBtn">Upload Screenshot</button>
        <button id="clearMarketScreensBtn">Clear Screenshots</button>
        <div id="screenshotGallery" style="display:flex; gap:5px; flex-wrap:wrap; margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div class="rightColumn">
    <div class="panel" id="vcPanel">
      <h2>üü¢ Live Voice Chat - Lordnine</h2>
      <div id="vcAlert"></div>
      <table id="active">
        <thead><tr><th>User</th><th>Channel</th><th>Status</th><th>Duration</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel" id="imagePanel" style="display:none;">
      <h2>üñºÔ∏è Upload image/screenshot for Attendance</h2>
      <input type="file" id="imageInput" multiple accept="image/*">
      <button id="uploadImagesBtn">Upload to Table</button>
      <table id="imageTable"><thead><tr><th>Preview</th><th>Filename</th><th>Status</th></tr></thead><tbody></tbody></table>
      <textarea id="imageMessage" placeholder="Optional message..."></textarea>
      <button id="sendImagesBtn">Send All to Discord</button>
      <button id="clearImageTableBtn">Clear Table</button>
      <button id="toggleHistoryBtn">Show Join/Leave History</button>
      <div id="notification" style="display:none;">‚úÖ Images sent!</div>
      <div id="history" style="display:none;"></div>

      <div id="adminSettings" style="margin-top:15px;">
        <h3>‚öôÔ∏è Admin Settings</h3>
        <div id="settingsDisplay">
          <p>Webhook URL: <span id="currentWebhook"></span></p>
          <p>Server ID: <span id="currentServer"></span></p>
          <p>Voice Channel ID: <span id="currentVoice"></span></p>
          <button id="editSettingsBtn">Edit</button>
          <button id="defaultSettingsBtn">Default</button>
        </div>
        <div id="settingsEdit" style="display:none;">
          <input type="text" id="webhookURL" placeholder="Webhook URL">
          <input type="text" id="serverID" placeholder="Server ID">
          <input type="text" id="voiceChannelID" placeholder="Voice Channel ID">
          <button id="saveSettingsBtn">Save</button>
          <button id="cancelEditBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- --- Scripts --- -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
// --- Socket & Attendance ---
const socket = io();
let attendance = {};
const activeBody = document.querySelector("#active tbody");
const historyDiv = document.getElementById("history");
const vcAlert = document.getElementById("vcAlert");

function showVCAlert(msg,type){
  vcAlert.textContent = msg;
  vcAlert.style.color = type==="join"?"#2ea043":"#da3633";
  vcAlert.style.display="block";
  setTimeout(()=>vcAlert.style.display="none",5000);
}

function formatDuration(sec){
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

function updateActive(){
  activeBody.innerHTML = "";
  const now = new Date();
  Object.entries(attendance.active||{}).forEach(([user,data])=>{
    const joined = new Date(data.joinedAt || Date.now());
    const dur = formatDuration(Math.floor((now-joined)/1000));
    const mute = data.selfMute || data.serverMute ? "üîá" : "üé§";
    const deaf = data.selfDeaf || data.serverDeaf ? "üîï" : "üëÇ";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${user}</td><td>${data.channel||"Unknown"}</td><td>${mute} ${deaf}</td><td>${dur}</td>`;
    activeBody.appendChild(tr);
  });
}

function updateHistory(){
  historyDiv.innerHTML = "";
  (attendance.history||[]).slice(-20).reverse().forEach(h=>{
    const d = document.createElement("div");
    const t = new Date(h.time).toLocaleTimeString();
    d.innerHTML = `<span class="${h.type==="join"?"joined":"left"}">${h.user}</span> ${h.type} <b>${h.channel}</b> at ${t}`;
    historyDiv.appendChild(d);
  });
}

setInterval(updateActive,1000);
socket.on("update", data => { attendance=data; updateActive(); updateHistory(); });

// --- Admin Login ---
const adminBtn=document.getElementById("adminBtn"),
      adminPassword=document.getElementById("adminPassword"),
      logoutBtn=document.getElementById("logoutBtn"),
      imagePanel=document.getElementById("imagePanel"),
      adminStatus=document.getElementById("adminStatus"),
      mainTabs=document.getElementById("mainTabs");

let adminLoggedIn = localStorage.getItem("adminLoggedIn")==="true";

function updateAdminUI(){
  adminStatus.style.display=adminLoggedIn?"inline-block":"none";
  logoutBtn.style.display=adminLoggedIn?"inline-block":"none";
  adminBtn.style.display=adminLoggedIn?"none":"inline-block";
  imagePanel.style.display=adminLoggedIn?"block":"none";
  adminPassword.style.display=adminLoggedIn?"none":"inline-block";
  mainTabs.style.display=adminLoggedIn?"block":"none";
  adminPassword.value="";
}

adminBtn.onclick = ()=>{adminPassword.style.display="inline-block"; adminPassword.focus();};
adminPassword.onkeyup = e => {
  if(e.key==="Enter"){
    if(adminPassword.value==="0212"){ 
      adminLoggedIn=true;
      localStorage.setItem("adminLoggedIn","true");
      updateAdminUI();
      alert("Admin logged in!");
    } else { alert("Wrong password"); adminPassword.value=""; }
  }
};
logoutBtn.onclick = ()=>{ adminLoggedIn=false; localStorage.setItem("adminLoggedIn","false"); updateAdminUI(); alert("Logged out!"); };
updateAdminUI();

// --- Tabs ---
const tabMarket=document.getElementById("tabMarket"),
      tabScreenshot=document.getElementById("tabScreenshot"),
      marketTab=document.getElementById("marketTab"),
      screenshotTab=document.getElementById("screenshotTab");

tabMarket.onclick = ()=>{ marketTab.style.display="block"; screenshotTab.style.display="none"; tabMarket.classList.add("tab-active"); tabScreenshot.classList.remove("tab-active"); };
tabScreenshot.onclick = ()=>{ marketTab.style.display="none"; screenshotTab.style.display="block"; tabMarket.classList.remove("tab-active"); tabScreenshot.classList.add("tab-active"); };

// --- Screenshot Uploads ---
let screenshots=JSON.parse(localStorage.getItem("screenshots")||"[]");
const screenshotGallery=document.getElementById("screenshotGallery");
function renderScreenshots(){
  screenshotGallery.innerHTML="";
  screenshots.forEach(img=>{
    const el=document.createElement("img");
    el.src=img; el.style.width="80px"; el.style.height="80px"; el.style.objectFit="cover";
    el.onclick=()=>window.open(img,"_blank");
    screenshotGallery.appendChild(el);
  });
}
renderScreenshots();
document.getElementById("uploadMarketScreensBtn").onclick=()=>{
  const files=document.getElementById("marketScreensInput").files;
  Array.from(files).forEach(f=>{
    const reader=new FileReader();
    reader.onload=e=>{
      screenshots.push(e.target.result);
      localStorage.setItem("screenshots",JSON.stringify(screenshots));
      renderScreenshots();
    };
    reader.readAsDataURL(f);
  });
};
document.getElementById("clearMarketScreensBtn").onclick=()=>{
  screenshots=[]; localStorage.removeItem("screenshots"); renderScreenshots();
};

// --- Admin Settings ---
const defaults = {
  webhookURL: "https://discord.com/api/webhooks/1433449406056763557/nifC_lCD78cMTOoMY6ryDBlain76udKiIEVOitIWT_n8XqygjGj_GWU0zDEf8v6GTxGu",
  serverID: "1038275000697901106",
  voiceChannelID: "1038275000697901110"
};
const currentWebhook=document.getElementById("currentWebhook"),
      currentServer=document.getElementById("currentServer"),
      currentVoice=document.getElementById("currentVoice"),
      editSettingsBtn=document.getElementById("editSettingsBtn"),
      defaultSettingsBtn=document.getElementById("defaultSettingsBtn"),
      saveSettingsBtn=document.getElementById("saveSettingsBtn"),
      cancelEditBtn=document.getElementById("cancelEditBtn"),
      settingsDisplay=document.getElementById("settingsDisplay"),
      settingsEdit=document.getElementById("settingsEdit"),
      webhookURLInput=document.getElementById("webhookURL"),
      serverIDInput=document.getElementById("serverID"),
      voiceChannelIDInput=document.getElementById("voiceChannelID");

function loadSettings(){
  const w=localStorage.getItem("webhookURL")||defaults.webhookURL;
  const s=localStorage.getItem("serverID")||defaults.serverID;
  const v=localStorage.getItem("voiceChannelID")||defaults.voiceChannelID;
  currentWebhook.textContent=w; currentServer.textContent=s; currentVoice.textContent=v;
  webhookURLInput.value=w; serverIDInput.value=s; voiceChannelIDInput.value=v;
}
editSettingsBtn.onclick = ()=>{ settingsDisplay.style.display="none"; settingsEdit.style.display="block"; };
cancelEditBtn.onclick = ()=>{ settingsDisplay.style.display="block"; settingsEdit.style.display="none"; };
saveSettingsBtn.onclick = ()=>{
  localStorage.setItem("webhookURL",webhookURLInput.value);
  localStorage.setItem("serverID",serverIDInput.value);
  localStorage.setItem("voiceChannelID",voiceChannelIDInput.value);
  loadSettings();
  settingsDisplay.style.display="block"; settingsEdit.style.display="none";
  alert("Settings saved!");
};
defaultSettingsBtn.onclick = ()=>{ Object.entries(defaults).forEach(([k,v])=>localStorage.setItem(k,v)); loadSettings(); alert("Restored default settings!"); };
loadSettings();
</script>
</body>
</html>
