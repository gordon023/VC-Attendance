<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord VC Attendance Tracker</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#0d1117; color:#e6edf3; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; }
    h1 { color:#238636; margin:20px; }
    .container { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; width:90%; }
    .panel { background:#161b22; border:1px solid #30363d; border-radius:12px; padding:20px; flex:1 1 300px; max-width:500px; }
    table { width:100%; border-collapse:collapse; }
    th,td { border-bottom:1px solid #30363d; padding:6px 10px; text-align:left; }
    th { color:#238636; }
    .joined { color:#238636; }
    .left { color:#da3633; }
    #history { max-height:250px; overflow-y:auto; }
  </style>
</head>
<body>
  <h1>üéß Discord VC Attendance Tracker</h1>
  <div class="container">
    <div class="panel">
      <h2>üü¢ Active Voice Chat Members</h2>
      <table id="active">
        <thead><tr><th>User</th><th>Channel</th><th>Duration</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="panel">
      <h2>üìú Join/Leave History</h2>
      <div id="history"></div>
    </div>
    <div class="panel">
  <h2>üñºÔ∏è Image Uploader</h2>
  <input type="file" id="imageInput" multiple accept="image/*">
  <button onclick="uploadImages()">Upload to Table</button>
  <table id="imageTable">
    <thead>
      <tr><th>Preview</th><th>Filename</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="sendImagesToDiscord()">Send All to Discord</button>
</div>

  </div>

 <script>
const socket = io();
let attendance = {};
const activeBody = document.querySelector("#active tbody");
const historyDiv = document.querySelector("#history");

socket.on("connect", () => console.log("‚úÖ Connected to server"));
socket.on("update", (data) => {
  attendance = data;
  updateActive();
  updateHistory();
});

function updateActive() {
  activeBody.innerHTML = "";
  const now = new Date();
  Object.entries(attendance.active || {}).forEach(([user, info]) => {
    const joined = new Date(info.joinedAt);
    const durationSec = Math.floor((now - joined)/1000);
    const durationText = formatDuration(durationSec);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${user}</td><td>${info.channel}</td><td>${durationText}</td>`;
    activeBody.appendChild(tr);
  });
}

function updateHistory() {
  historyDiv.innerHTML = "";
  (attendance.history || []).slice(0, 20).forEach(h => {
    const div = document.createElement("div");
    const time = new Date(h.time).toLocaleTimeString();
    const typeClass = h.type === "join" ? "joined" : "left";
    const action = h.type === "join" ? "joined" : "left";
    div.innerHTML = `<span class="${typeClass}">${h.user}</span> ${action} <b>${h.channel}</b> at ${time}`;
    historyDiv.appendChild(div);
  });
}

function formatDuration(sec) {
  const h = Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

setInterval(updateActive, 1000);

// ---------------- IMAGE UPLOADER ----------------
const imageInput = document.getElementById("imageInput");
const imageTableBody = document.querySelector("#imageTable tbody");
let uploadedImages = JSON.parse(localStorage.getItem("uploadedImages") || "[]");
renderImageTable();

function uploadImages() {
  const files = Array.from(imageInput.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      uploadedImages.push({ fileName: file.name, dataURL: e.target.result, status: "Pending" });
      renderImageTable();
      saveToLocalStorage();
    };
    reader.readAsDataURL(file);
  });
  imageInput.value = "";
}

function renderImageTable() {
  imageTableBody.innerHTML = "";
  uploadedImages.forEach((img) => {
    const tr = document.createElement("tr");
    let statusClass = "status-pending";
    if(img.status === "Uploading") statusClass = "status-uploading";
    if(img.status === "Sent") statusClass = "status-sent";
    if(img.status === "Failed") statusClass = "status-failed";
    tr.innerHTML = `
      <td><img src="${img.dataURL}" style="max-width:50px;max-height:50px;"></td>
      <td>${img.fileName}</td>
      <td class="${statusClass}">${img.status}</td>
    `;
    imageTableBody.appendChild(tr);
  });
}

function saveToLocalStorage() {
  localStorage.setItem("uploadedImages", JSON.stringify(uploadedImages));
}

async function sendImagesToDiscord() {
  if (uploadedImages.length === 0) return alert("No images to send!");
  for (let i = 0; i < uploadedImages.length; i++) {
    uploadedImages[i].status = "Uploading";
    renderImageTable();
    saveToLocalStorage();
    try {
      await fetch("https://discord.com/api/webhooks/1433449406056763557/nifC_lCD78cMTOoMY6ryDBlain76udKiIEVOitIWT_n8XqygjGj_GWU0zDEf8v6GTxGu", {
        method: "POST",
        body: JSON.stringify({ content: "", embeds: [], files: [{ name: uploadedImages[i].fileName, content: uploadedImages[i].dataURL.split(",")[1] }] }),
        headers: { "Content-Type": "application/json" }
      });
      uploadedImages[i].status = "Sent";
      renderImageTable();
      saveToLocalStorage();
    } catch(err) {
      console.error(err);
      uploadedImages[i].status = "Failed";
      renderImageTable();
      saveToLocalStorage();
    }
  }

  // Automatically clear sent images after 15 seconds
  const sentCount = uploadedImages.filter(img => img.status === "Sent").length;
  if(sentCount > 0){
    setTimeout(() => {
      uploadedImages = uploadedImages.filter(img => img.status !== "Sent");
      renderImageTable();
      saveToLocalStorage();
      alert(`${sentCount} image(s) successfully uploaded to Discord and cleared!`);
    }, 15000);
  }
}
</script>

</body>
</html>
