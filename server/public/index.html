<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ™ï¸ Discord VC Attendance Tracker</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center py-8">
  <div class="w-full max-w-6xl bg-gray-800 p-6 rounded-2xl shadow-lg">
    <h1 class="text-3xl font-bold mb-6 text-center">ğŸ™ï¸ Discord VC Attendance Tracker</h1>

    <!-- Active Users -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-xl font-semibold mb-2">ğŸŸ¢ Currently Active</h2>
        <ul id="activeList" class="space-y-2"></ul>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-2">ğŸ•’ Join / Leave History</h2>
        <ul id="historyList" class="space-y-1 text-sm"></ul>
      </div>
    </div>

    <!-- Total Time -->
    <h2 class="text-xl font-semibold mt-8 mb-3">ğŸ† Total VC Time</h2>
    <ul id="totalList" class="space-y-1 text-sm"></ul>

    <!-- Leaderboards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-10">
      <div>
        <h2 class="text-xl font-semibold mb-2">ğŸ“… Daily Leaderboard</h2>
        <ul id="dailyBoard" class="space-y-1 text-sm"></ul>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-2">ğŸ“† Weekly Leaderboard</h2>
        <ul id="weeklyBoard" class="space-y-1 text-sm"></ul>
      </div>
    </div>

    <!-- Export -->
    <div class="text-center mt-10">
      <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">
        â¬‡ï¸ Export Attendance (XLSX)
      </button>
    </div>
  </div>

  <script>
    const socket = io();
    const activeList = document.getElementById("activeList");
    const historyList = document.getElementById("historyList");
    const totalList = document.getElementById("totalList");
    const dailyBoard = document.getElementById("dailyBoard");
    const weeklyBoard = document.getElementById("weeklyBoard");
    const exportBtn = document.getElementById("exportBtn");

    let attendance = {};

    socket.on("update", data => {
      attendance = data;
      render();
    });

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h}h ${m}m ${s}s`;
    }

    function render() {
      const now = new Date();

      // Active users
      activeList.innerHTML = "";
      for (const [user, info] of Object.entries(attendance.active || {})) {
        const joinedAt = new Date(info.joinedAt);
        const seconds = Math.floor((now - joinedAt) / 1000);
        const li = document.createElement("li");
        li.className = "p-2 bg-gray-700 rounded-lg flex justify-between";
        li.textContent = `${user} (${info.channel}) â€” ${formatTime(seconds)} active`;
        activeList.appendChild(li);
      }

      // History
      historyList.innerHTML = "";
      (attendance.history || []).slice(0, 10).forEach(e => {
        const li = document.createElement("li");
        const action = e.type === "join" ? "ğŸŸ¢ joined" : "ğŸ”´ left";
        li.textContent = `${e.user} ${action} ${e.channel} at ${new Date(e.time).toLocaleTimeString()}`;
        historyList.appendChild(li);
      });

      // Total time leaderboard
      totalList.innerHTML = "";
      const sorted = Object.entries(attendance.stats || {}).sort((a, b) => b[1] - a[1]);
      sorted.forEach(([user, seconds]) => {
        const li = document.createElement("li");
        li.textContent = `${user}: ${formatTime(seconds)}`;
        totalList.appendChild(li);
      });
    }

    // Live timer
    setInterval(render, 1000);

    // Leaderboard fetchers
    async function updateLeaderboards() {
      const [daily, weekly] = await Promise.all([
        fetch("/leaderboard/daily").then(r => r.json()).catch(() => []),
        fetch("/leaderboard/weekly").then(r => r.json()).catch(() => []),
      ]);

      dailyBoard.innerHTML = daily.length
        ? daily.map((u, i) => `<li>${i + 1}. ${u.user} â€” ${u.time}</li>`).join("")
        : "<li>No data</li>";

      weeklyBoard.innerHTML = weekly.length
        ? weekly.map((u, i) => `<li>${i + 1}. ${u.user} â€” ${u.time}</li>`).join("")
        : "<li>No data</li>";
    }

    setInterval(updateLeaderboards, 10000);
    updateLeaderboards();

    // Export XLSX
    exportBtn.addEventListener("click", () => {
      window.location.href = "/export/xlsx";
    });
  </script>
</body>
</html>
